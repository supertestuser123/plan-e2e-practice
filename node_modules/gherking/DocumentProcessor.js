"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DocumentProcessor = void 0;
const tslib_1 = require("tslib");
const FeatureProcessor_1 = require("./FeatureProcessor");
const Processor_1 = require("./Processor");
const debug_1 = require("./debug");
const debug = (0, debug_1.getDebugger)("DocumentProcessor");
class DocumentProcessor extends Processor_1.ProcessorBase {
    constructor(preCompiler) {
        debug("constructor(%o)", preCompiler);
        super(preCompiler);
        this.featureProcessor = new FeatureProcessor_1.FeatureProcessor(preCompiler);
    }
    execute(e) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            /* istanbul ignore next */
            debug("execute(e: %s)", e === null || e === void 0 ? void 0 : e.constructor.name);
            if (!e) {
                return [];
            }
            const document = e.clone();
            if (!document.feature) {
                debug("...!feature");
                return [];
            }
            const features = yield this.featureProcessor.execute(document.feature, document);
            if (!features) {
                debug("...!features");
                return [];
            }
            debug("...Array %d", features.length);
            const newDocuments = [];
            for (let i = 0; i < features.length; ++i) {
                const feature = features[i];
                debug("...map(i: %d)", i);
                const newDocument = e.clone();
                newDocument.feature = feature;
                if (!this.preCompiler.onDocument) {
                    newDocuments.push(newDocument);
                    continue;
                }
                const result = yield this.preCompiler.onDocument(newDocument);
                debug("...onDocument(result: %s)", typeof result);
                newDocuments.push(result === null ? null : result || newDocument);
            }
            return newDocuments.filter(Boolean);
        });
    }
}
exports.DocumentProcessor = DocumentProcessor;
//# sourceMappingURL=DocumentProcessor.js.map